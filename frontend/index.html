<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QuestMaster Interactive Story</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body>
  <div id="root">Loading...</div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { motion, AnimatePresence } = window['framer-motion'];

    const NarrativePanel = ({ text }) => (
      <pre className="bg-gray-100 p-4 rounded h-40 overflow-y-auto whitespace-pre-wrap">
        {text}
      </pre>
    );

    const LocationHeader = ({ location, image }) => (
      <div className="text-xl font-bold flex items-center gap-2 mb-2">
        {image && <img src={image} alt={location} className="w-8 h-8" />}
        <span>{location}</span>
      </div>
    );

    const ChoicesList = ({ moves, obstacle, onMove, onDefeat }) => (
      <div className="space-x-2 space-y-2">
        {obstacle && (
          <button
            className="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 focus:outline-none"
            onClick={() => onDefeat(obstacle)}
          >
            Defeat {obstacle}
          </button>
        )}
        {moves.map(m => (
          <button
            key={m}
            className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none"
            onClick={() => onMove(m)}
          >
            Go to {m}
          </button>
        ))}
      </div>
    );

    const ProgressBar = ({ progress }) => (
      <div className="w-full bg-gray-300 h-2 rounded">
        <div
          className="bg-green-500 h-2 rounded"
          style={{ width: `${Math.floor(progress * 100)}%` }}
        />
      </div>
    );

    const ActionLog = ({ log }) => (
      <ul className="text-sm space-y-1">
        {log.map((l, i) => (
          <li key={i}>{l.time} â€“ {l.text}</li>
        ))}
      </ul>
    );

    const App = () => {
      const [quest, setQuest] = useState(null);
      const [narrative, setNarrative] = useState('');
      const [state, setState] = useState({ location: null, defeated: [], log: [] });
      const [completed, setCompleted] = useState(false);

      useEffect(() => {
        const saved = localStorage.getItem('quest_state');
        if (saved) {
          try { setState(JSON.parse(saved)); } catch {}
        }
        fetch('../examples/output/metadata.json')
          .then(r => r.json())
          .then(j => {
            setQuest(j.quest_data);
            if (!saved) {
              setState(s => ({ ...s, location: j.quest_data.initial_location }));
            }
          });
        fetch('../examples/output/narrative.txt')
          .then(r => r.text())
          .then(t => setNarrative(t));
      }, []);

      useEffect(() => {
        if (quest && state.location) {
          localStorage.setItem('quest_state', JSON.stringify(state));
          const achieved = quest.goal_conditions.every(c => {
            if (c.startsWith('at ')) {
              const target = c.split(' ')[2];
              return state.location === target;
            }
            if (c.startsWith('defeated ')) {
              const ob = c.split(' ')[1];
              return state.defeated.includes(ob);
            }
            return false;
          });
          setCompleted(achieved);
        }
      }, [state, quest]);

      if (!quest || !state.location) return <div className="p-4">Loading...</div>;

      const moves = quest.connections
        .filter(c => c[0] === state.location)
        .map(c => c[1]);

      const obstacle = quest.obstacles[state.location];
      const isDefeated = obstacle && state.defeated.includes(obstacle);

      const progressCount = quest.goal_conditions.filter(c => {
        if (c.startsWith('at ')) return state.location === c.split(' ')[2];
        if (c.startsWith('defeated ')) return state.defeated.includes(c.split(' ')[1]);
        return false;
      }).length / quest.goal_conditions.length;

      const moveTo = dest => {
        setState(s => ({ ...s, location: dest, log: s.log.concat({ time: new Date().toLocaleTimeString(), text: `Moved to ${dest}` }) }));
      };

      const defeat = ob => {
        if (!state.defeated.includes(ob)) {
          setState(s => ({ ...s, defeated: s.defeated.concat(ob), log: s.log.concat({ time: new Date().toLocaleTimeString(), text: `Defeated ${ob}` }) }));
        }
      };

      const restart = () => {
        localStorage.removeItem('quest_state');
        setState({ location: quest.initial_location, defeated: [], log: [] });
        setCompleted(false);
      };

      return (
        <div className="max-w-4xl mx-auto p-4 space-y-4">
          <h1 className="text-2xl font-bold">QuestMaster Interactive Story</h1>
          <ProgressBar progress={progressCount} />
          <div className="md:grid md:grid-cols-2 gap-4">
            <div className="space-y-4">
              <NarrativePanel text={narrative} />
              <ActionLog log={state.log} />
            </div>
            <AnimatePresence mode="wait">
              <motion.div key={state.location} initial={{ opacity: 0, x: 50 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -50 }} transition={{ duration: 0.3 }} className="space-y-4">
                <LocationHeader location={state.location} />
                {completed ? (
                  <div className="p-4 bg-green-100 rounded shadow">Quest Completed!</div>
                ) : (
                  <ChoicesList
                    moves={moves}
                    obstacle={!isDefeated ? obstacle : null}
                    onMove={moveTo}
                    onDefeat={defeat}
                  />
                )}
              </motion.div>
            </AnimatePresence>
          </div>
          <div className="text-right">
            <button className="mt-2 text-sm underline" onClick={restart}>Restart Quest</button>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
